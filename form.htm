<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" />
<style>
    p {
        margin-bottom: 20px;
    }
    h2 {
        margin-bottom: 20px;
    }
    button {
        font-family: Consolas, monospace;
        color: #222;
        background-color: #5bc0de;
    }
    body {
        margin: 20px;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script>
var prev_size = 0;
var current_size = 0;
var counter = 0;

function get_progress(location) {
    var button = document.getElementById('go');
    var progressurl = location.replace('/p/', '/progress/').replace('.gif', '');
    console.log('Trying progress URL ' + progressurl);
    var resp = '';
    var request = new XMLHttpRequest();
    request.open('GET', progressurl, true);
    request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
            var resp = request.responseText;
            console.log('BUTTON TEXT = ' + resp);
            button.innerText = resp;
            current_size = resp;
            if (prev_size == current_size) {
                counter++;
            }                     
            if (counter == 3) {
                //button.innerText =   'PROBABLY READY';
                window.clearInterval();
                window.location.href = location;
            }
            prev_size = current_size;
            console.log('counter='+counter);
        }
        else {
            var resp = 'error';
        }
        return resp;
    };
    request.onerror = function() {
        // There was a connection error of some sort
    };
    request.send();
}

function print_deploymentid() {
    var request = new XMLHttpRequest();
    request.open('GET', '/api/deployment', true);
    request.setRequestHeader(
        'Accept', 'application/json'
    );
    request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
            var body = request.responseText;
            console.log('Response: ' + request.status + ' ' + request.statusText);
            console.log('Body: ' + body);
            var commitid = document.getElementById('commitid');
            commitid.innerHTML = 'Deployment Id: ' + body;
        }
        else {
            console.error('error ' + request.status);
        }
    };
    request.onerror = function(err) {
       console.error(err);
    };
    request.send();
}

function post() {
    var button = document.getElementById('go');
    button.innerText = 'Fetching GIF...';
    var request = new XMLHttpRequest();
    var gifurl = document.getElementById('gifurl').value;
    var text = document.getElementById('text').value;
    console.log('POST ' + gifurl + ' ' + text);
    request.open('POST', '/', true);
    request.setRequestHeader(
            'Content-type', 'application/x-www-form-urlencoded'
    );
    request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
            // Success!
            var resp = request.responseText;
            console.log('Response: ' + request.status +
                        ' ' + request.statusText);
            console.dir('Location: ' + request.getResponseHeader('Location'));
            var location = request.getResponseHeader('Location');
            setInterval(function() {
                console.log('loc ' + location);
                get_progress(location);
            }, 3000);
        }
        else {
            console.error('error ' + request.status);
            button.innerText = request.responseText;;
        }
    };
    request.onerror = function(err) {
       console.error(err);
    };
    request.send('gifurl=' + gifurl + '&text=' + text);
    return false; // should be using preventDefault()
}


print_deploymentid();
</script>

</head>

<body>

    <code>
        Source here -- <a href="https://github.com/snobu/gifinator" title="GitHub">https://github.com/snobu/gifinator</a> -- Contributions welcome!
    </code>
    <br>
    <code id="commitid">
      <!-- commit id -->
    </code>

    <div class="container">

      <div id="form" class="form-signin">
        <h2 class="form-signin-heading">Write on animated GIFs</h2>
        <p>Need some inspiration? - <a href="http://giphy.com/" title="Giphy" target="_blank">http://giphy.com</a> (Right click on gifs -> Copy image address)<br>imgur.com is fine too, we detect image ID from stuff like imgur.com/BlaHbLAh and fetch the .gif</p>
        <p>
          <label for="gifurl" class="sr-only">.gif URL</label>
          <input type="text" id="gifurl" name="gifurl" class="form-control" placeholder=".gif URL" required autofocus>
        </p>
        <p>
          <label for="text" class="sr-only">Annotate with text</label>
          <input type="text" id="text" name="text" class="form-control" placeholder="Annotate with text" required>
        </p>
        <p>
          <button class="btn btn-lg btn-block" id="go" type="submit"
              onClick="post()" onsubmit="return false">Make GIF</button>
        <p>
    </div>

    </div> <!-- /container -->

    <div style="margin-top: 120px">
      <center>
        <p>Running on Azure App Service in a Linux worker</p>
        <img src="https://azure.microsoft.com/svghandler/app-service/?width=60" />
      </center>
    </div>

</body>
</html>
